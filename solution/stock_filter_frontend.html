<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强版股票筛选器</title>
    <!-- 引入Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <!-- 引入Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入Element Plus JS -->
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- 引入Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #303133;
            font-size: 28px;
            font-weight: 600;
        }
        .filter-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .result-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            padding: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ebeef5;
        }
        .filter-form {
            margin-top: 20px;
        }
        .form-row {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-item {
            flex: 1;
            min-width: 250px;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .form-item:last-child {
            margin-right: 0;
        }
        .form-label {
            display: inline-block;
            width: 120px;
            text-align: right;
            margin-right: 10px;
            font-weight: 500;
            color: #606266;
        }
        .form-controls {
            display: inline-block;
            vertical-align: middle;
        }
        .button-group {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ebeef5;
            display: flex;
            gap: 10px;
        }
        .divider {
            margin: 20px 0;
            position: relative;
            text-align: left;
        }
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #ebeef5;
        }
        .divider::after {
            content: attr(data-content);
            position: relative;
            padding-right: 10px;
            background-color: #ffffff;
            color: #303133;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="header">
            <h1>增强版股票筛选器</h1>
        </div>
        
        <div class="filter-card">
            <div class="card-header">
                <span>股票筛选条件</span>
            </div>
            
            <div class="filter-form">
                <!-- 基本信息筛选 -->
                <div class="divider" data-content="基本信息"></div>
                <div class="form-row">
                    <div class="form-item">
                        <label class="form-label">股票代码</label>
                        <div class="form-controls">
                            <el-input v-model="filterForm.stockCode" placeholder="请输入股票代码" style="width: 200px;"></el-input>
                        </div>
                    </div>
                    <div class="form-item">
                        <label class="form-label">行业分类</label>
                        <div class="form-controls">
                            <el-select v-model="filterForm.industry" placeholder="请选择行业" style="width: 200px;" clearable>
                                <el-option label="全部" value=""></el-option>
                                <el-option v-for="industry in industries" :key="industry" :label="industry" :value="industry"></el-option>
                            </el-select>
                        </div>
                    </div>
                    <div class="form-item">
                        <label class="form-label">地区分布</label>
                        <div class="form-controls">
                            <el-select v-model="filterForm.area" placeholder="请选择地区" style="width: 200px;" clearable>
                                <el-option label="全部" value=""></el-option>
                                <el-option label="北京" value="北京"></el-option>
                                <el-option label="上海" value="上海"></el-option>
                                <el-option label="广东" value="广东"></el-option>
                                <el-option label="浙江" value="浙江"></el-option>
                                <el-option label="江苏" value="江苏"></el-option>
                            </el-select>
                        </div>
                    </div>
                </div>

                <!-- 估值指标筛选 -->
                <div class="divider" data-content="估值指标"></div>
                <div class="form-row">
                    <div class="form-item">
                        <label class="form-label">市盈率(PE)</label>
                        <div class="form-controls">
                            <el-input-number v-model="filterForm.peMin" placeholder="最小值" :min="0" style="width: 100px;"></el-input-number>
                            <span style="margin: 0 10px;">-</span>
                            <el-input-number v-model="filterForm.peMax" placeholder="最大值" :min="0" style="width: 100px;"></el-input-number>
                        </div>
                    </div>
                    <div class="form-item">
                        <label class="form-label">市净率(PB)</label>
                        <div class="form-controls">
                            <el-input-number v-model="filterForm.pbMin" placeholder="最小值" :min="0" style="width: 100px;"></el-input-number>
                            <span style="margin: 0 10px;">-</span>
                            <el-input-number v-model="filterForm.pbMax" placeholder="最大值" :min="0" style="width: 100px;"></el-input-number>
                        </div>
                    </div>
                    <div class="form-item">
                        <label class="form-label">市值(亿元)</label>
                        <div class="form-controls">
                            <el-input-number v-model="filterForm.marketCapMin" placeholder="最小值" :min="0" style="width: 100px;"></el-input-number>
                            <span style="margin: 0 10px;">-</span>
                            <el-input-number v-model="filterForm.marketCapMax" placeholder="最大值" :min="0" style="width: 100px;"></el-input-number>
                        </div>
                    </div>
                </div>

                <!-- 技术指标筛选 -->
                <div class="divider" data-content="技术指标"></div>
                <div class="form-row">
                    <div class="form-item">
                        <label class="form-label">RSI相对强弱</label>
                        <div class="form-controls">
                            <el-input-number v-model="filterForm.rsiMin" placeholder="最小值" :min="0" :max="100" style="width: 100px;"></el-input-number>
                            <span style="margin: 0 10px;">-</span>
                            <el-input-number v-model="filterForm.rsiMax" placeholder="最大值" :min="0" :max="100" style="width: 100px;"></el-input-number>
                        </div>
                    </div>
                </div>

                <!-- 财务指标筛选 -->
                <div class="divider" data-content="财务指标"></div>
                <div class="form-row">
                    <div class="form-item">
                        <label class="form-label">资产负债率(%)</label>
                        <div class="form-controls">
                            <el-input-number v-model="filterForm.debtRatioMin" placeholder="最小值" :min="0" :max="100" style="width: 100px;"></el-input-number>
                            <span style="margin: 0 10px;">-</span>
                            <el-input-number v-model="filterForm.debtRatioMax" placeholder="最大值" :min="0" :max="100" style="width: 100px;"></el-input-number>
                        </div>
                    </div>
                    <div class="form-item">
                        <label class="form-label">流动比率</label>
                        <div class="form-controls">
                            <el-input-number v-model="filterForm.currentRatioMin" placeholder="最小值" :min="0" style="width: 100px;"></el-input-number>
                            <span style="margin: 0 10px;">-</span>
                            <el-input-number v-model="filterForm.currentRatioMax" placeholder="最大值" :min="0" style="width: 100px;"></el-input-number>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="button-group">
                    <el-button type="primary" @click="handleFilter" :loading="loading">
                        <el-icon><Search /></el-icon>
                        筛选股票
                    </el-button>
                    <el-button @click="handleReset">
                        <el-icon><Refresh /></el-icon>
                        重置条件
                    </el-button>
                    <el-button type="success" @click="handleExport" :disabled="!hasResults">
                        <el-icon><Download /></el-icon>
                        导出结果
                    </el-button>
                </div>
            </div>
        </div>

        <!-- 筛选结果 -->
        <div v-if="hasResults" class="result-card">
            <div class="card-header">
                <span>筛选结果 ({{ filteredStocks.length }} 只股票)</span>
            </div>
            
            <el-table :data="formattedStocks" stripe style="width: 100%">
                <el-table-column prop="stockCode" label="股票代码" width="120"></el-table-column>
                <el-table-column prop="stockName" label="股票名称" width="150"></el-table-column>
                <el-table-column prop="industry" label="行业" width="120"></el-table-column>
                <el-table-column prop="area" label="地区" width="100"></el-table-column>
                <el-table-column prop="peRatio" label="市盈率" width="100"></el-table-column>
                <el-table-column prop="pbRatio" label="市净率" width="100"></el-table-column>
                <el-table-column prop="marketCap" label="市值(万)" width="120"></el-table-column>
                <el-table-column prop="rsi" label="RSI" width="80"></el-table-column>
                <el-table-column prop="debtRatio" label="资产负债率%" width="120"></el-table-column>
                <el-table-column prop="currentRatio" label="流动比率" width="100"></el-table-column>
                <el-table-column label="操作" width="150">
                    <template #default="scope">
                        <el-button size="small" @click="handleViewDetail(scope.row)">详情</el-button>
                        <el-button size="small" type="primary" @click="handleAddToStrategy(scope.row)">加入策略</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        const { ElMessage, ElLoading } = ElementPlus
        const { Search, Refresh, Download } = ElementPlusIconsVue

        createApp({
            setup() {
                // 筛选表单数据
                const filterForm = ref({
                    stockCode: '',
                    industry: '',
                    area: '',
                    peMin: null,
                    peMax: null,
                    pbMin: null,
                    pbMax: null,
                    marketCapMin: null,
                    marketCapMax: null,
                    rsiMin: null,
                    rsiMax: null,
                    debtRatioMin: null,
                    debtRatioMax: null,
                    currentRatioMin: null,
                    currentRatioMax: null
                })

                // 筛选结果
                const filteredStocks = ref([])
                const loading = ref(false)

                // 计算属性
                const hasResults = computed(() => filteredStocks.value.length > 0)
                
                // 格式化后的股票数据（优化显示格式）
                const formattedStocks = computed(() => {
                    return filteredStocks.value.map(stock => {
                        return {
                            ...stock,
                            // 市值转换为万单位并保留两位小数
                            marketCap: formatMarketCap(stock.marketCap),
                            // 资产负债率保留两位小数
                            debtRatio: formatDebtRatio(stock.debtRatio),
                            // 流动比率保留两位小数
                            currentRatio: stock.currentRatio ? stock.currentRatio.toFixed(2) : '0.00',
                            // RSI显示处理
                            rsi: stock.rsi ? stock.rsi.toFixed(2) : '0.00'
                        }
                    })
                })

                // 格式化市值函数（转换为万单位并保留两位小数）
                function formatMarketCap(marketCap) {
                    if (!marketCap) return '0.00'
                    // 原市值单位为亿元，转换为万元
                    const marketCapInWan = marketCap * 10000
                    return marketCapInWan.toFixed(2)
                }

                // 格式化资产负债率函数（保留两位小数）
                function formatDebtRatio(debtRatio) {
                    if (debtRatio === null || debtRatio === undefined) return '0.00'
                    return debtRatio.toFixed(2)
                }

                // 筛选股票
                const handleFilter = async () => {
                    loading.value = true
                    try {
                        // 模拟API调用，实际使用时替换为真实API
                        // 由于无法直接修改现有后端，这里提供一个模拟的实现
                        // 在实际环境中，应该调用我们创建的enhanced_stock_filter.py中的功能
                        
                        // 模拟API响应延迟
                        await new Promise(resolve => setTimeout(resolve, 500))
                        
                        // 这里应该是实际的API调用
                        // const response = await axios.post('/stocks/filter', filterForm.value)
                        // filteredStocks.value = response.data.stocks
                        
                        // 由于无法直接修改后端，这里提供一个模拟的数据
                        // 实际使用时应替换为真实的API调用
                        console.log('筛选条件:', filterForm.value)
                        
                        // 这里仅作为演示，实际项目中应该使用真实的API
                        ElMessage.success('筛选功能已配置完成，请集成到现有后端系统中使用')
                        
                    } catch (error) {
                        ElMessage.error('筛选失败，请重试')
                        console.error('筛选错误:', error)
                    } finally {
                        loading.value = false
                    }
                }

                // 重置筛选条件
                const handleReset = () => {
                    Object.keys(filterForm.value).forEach(key => {
                        if (typeof filterForm.value[key] === 'string') {
                            filterForm.value[key] = ''
                        } else {
                            filterForm.value[key] = null
                        }
                    })
                    filteredStocks.value = []
                    ElMessage.info('筛选条件已重置')
                }

                // 导出结果
                const handleExport = () => {
                    ElMessage.success('导出功能开发中...')
                }

                // 查看股票详情
                const handleViewDetail = (row) => {
                    ElMessage.info(`查看 ${row.stockName} 详情`)
                }

                // 加入策略
                const handleAddToStrategy = (row) => {
                    ElMessage.success(`已将 ${row.stockName} 加入策略`)
                }

                // 加载行业列表
                const industries = ref(['银行', '证券', '保险', '房地产', '医药生物', '电子', '计算机', '通信'])

                return {
                    filterForm,
                    filteredStocks,
                    loading,
                    hasResults,
                    formattedStocks,
                    industries,
                    handleFilter,
                    handleReset,
                    handleExport,
                    handleViewDetail,
                    handleAddToStrategy
                }
            }
        }).use(ElementPlus).mount('#app')
    </script>
</body>
</html>